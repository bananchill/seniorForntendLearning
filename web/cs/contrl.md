# Техническое задание

## 1. Цель проекта

Создать web-приложение, которое автоматически собирает предложения о скинах с площадок **CSFloat, Market CSGO, CS.Money, LisSkins**, вычисляет минимальную потенциальную прибыль каждого лота и в реальном времени показывает пользователю только прибыльные позиции с возможностью гибкой фильтрации.

---

## 2. Функциональные требования

| Код  | Требование                                                       | Приёмочный критерий                                              |
| ---- | ---------------------------------------------------------------- | ---------------------------------------------------------------- |
| FR-1 | Пользователь задаёт фильтры: наклейки, `float`-диапазон, паттерн | Фильтр применяется ≤ 2 с, отфильтрованный список ≤ 200 элементов |
| FR-2 | Система отображает поле **Min Profit** в \$                      | Значение ≥ 0; элементы с < 0 автоматически скрыты                |
| FR-3 | Сортировка по прибыли, цене, `float`                             | Сортировка клиентская, без дополнительного API-запроса           |
| FR-4 | Обновление ленты в реальном времени                              | WebSocket-push, задержка ≤ 5 с от поступления данных             |
| FR-5 | Ссылка на источник                                               | Открывается в новой вкладке, UTM-метки заказчика                 |

---

## 3. Нефункциональные требования

| Категория           | Метрика                                      |
| ------------------- | -------------------------------------------- |
| Производительность  | 95-й перцентиль REST-запросов ≤ 500 мс       |
| Актуальность данных | Максимальная “старость” данных 3 мин         |
| Масштабируемость    | 10к одновременных подключений WebSocket      |
| Надёжность          | 99,5 % Uptime (месячный)                     |
| Безопасность        | OWASP Top-10, Rate-limit 100 req/10 мин/IP   |
| Качество кода       | ESLint, Prettier, 80 % покрытие unit-тестами |
| CI/CD               | Полный пайплайн lint → test → build → deploy |

---

## 4. Архитектура решения

### 4.1 Общая схема

```
(frontend) ──► REST API ─► Application Layer ─► Domain Layer ─► PostgreSQL
         ▲            │                 │                  │
         │            └── WebSocket Gateway ◄─ Redis Pub/Sub│
         │                                      ▲          │
         └──────────────────────── socket.io ◄──┘          │
                                                            ▼
                               Source Adapters ⇆ Площадки (CSFloat, …)
```

### 4.2 Подсистемы

| Подсистема          | Назначение                                                                                 | Технологии                                     |
| ------------------- | ------------------------------------------------------------------------------------------ | ---------------------------------------------- |
| **Integration**     | Адаптеры к каждому-из 4 площадок, нормализация данных, крон-таски                          | NestJS module + Axios / Node-ws                |
| **Queue & Cache**   | Очереди на обновление лотов, кэш для WebSocket доставки                                    | **Redis 7 + BullMQ**                           |
| **Domain / Profit** | Расчёт `minProfit` по формуле *(средняя рыночная цена − 13 % комиссии − цена предложения)* | Сервис уровня Domain                           |
| **API Gateway**     | REST + Swagger, валидация DTO, пагинация                                                   | NestJS Controllers, Zod/Pipe Validation        |
| **WebSocket**       | Трансляция новых/обновлённых лотов клиентам                                                | NestJS `@WebSocketGateway` + socket.io-adapter |
| **Frontend SPA**    | UI фильтров, таблица результатов, состояние приложения                                     | React 18, Vite, Tailwind CSS, Zustand          |
| **Monitoring**      | Метрики, алерты, логи                                                                      | Prometheus, Grafana, Loki                      |

---

## 5. Технологический стек

| Зона     | Инструменты                                                                                |
| -------- |--------------------------------------------------------------------------------------------|
| Backend  | **Node 18, NestJS 10, TypeScript 5, PostgreSQL 15, Redis 7, BullMQ, Docker, Jest**     |
| Frontend | **React 18, Vite 5, TypeScript 5, Tailwind CSS 3, socket, React Query, Vitest**  |
| DevOps   | GitHub Actions, Docker Compose (dev)             |
| QA       | Jest, Supertest (E2E), React Testing Library, Playwright (UI)                              |

---

## 6. Данные и хранение

### 6.1 Основные сущности

* **Skin**: `id, name, float, pattern, stickers[], priceUsd, minProfitUsd, source, sourceItemId, updatedAt`
* **Sticker** (справочник)
* **SourceListing**: исходный JSON для аудита

### 6.2 Индексы

* `updatedAt` (скорость синхронизации)
* `gin(stickers)` (поиск по наклейкам)

---

## 7. Интеграции с площадками

| Площадка    | Доступ           | Метод       | Интервал обновления | Ограничения       |
| ----------- | ---------------- | ----------- | ------------------- | ----------------- |
| CSFloat     | REST             | `/listings` | 60 с                | 30 req/min        |
| Market CSGO | HTML-scrape      | `/market`   | 120 с               | Cloudflare-bypass |
| CS.Money    | WebSocket stream | `wss://...` | постоянный          | reconnect logic   |
| LisSkins    | REST             | `/items`    | 60 с                | API-key           |

---

## 8. Окружения

| Env         | Цель                                       | URL-шаблон                             |
| ----------- | ------------------------------------------ | -------------------------------------- |
| **Dev**     | локальная разработка (`docker-compose up`) | `http://localhost:3000`                |
| **Staging** | приёмка QA                                 | `https://staging-cs-skins.example.com` |
| **Prod**    | боевая эксплуатация                        | `https://cs-skins.example.com`         |

Все секреты через **HashiCorp Vault**, переменные окружения не коммитятся.

---

## 9. План

| Номер | Этап                                           | Артефакты             |
|-------| ---------------------------------------------- | --------------------- |
| 1     | Sprint 0: настройка репо, линтеров, CI, Docker | рабочий pipeline      |
| 2–3   | Модуль интеграции CSFloat + схема БД           | миграции, cron-задача |
| 4–5   | Добавление Market CSGO + Profit-service        | unit-тесты расчёта    |
| 6–7   | Модуль CS.Money WebSocket + Redis-очереди      | live-поток в Redis    |
| 8     | LisSkins + полный набор адаптеров              | обновлённый Swagger   |
| 9     | WebSocket Gateway + клиент-SDK                 | demo realtime         |
| 10    | UI фильтров и таблица (React)                  | Storybook-каталог     |
| 11    | E2E-тесты, нагрузочное тестирование            | отчёт performance     |
| 12    | Релиз, прод-допуск, ретроспектива              | prod URL              |

---
